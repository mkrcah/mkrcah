<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title data-react-helmet="true">marcel.is | How a newline can ruin your Hive</title><meta data-react-helmet="true" name="description" content="Marcel Krcah blog"/><meta data-react-helmet="true" name="keywords" content="Big Data, Software Engineering, Marcel Krcah"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.625em -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;font-weight:normal;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}h1{margin-left:0;margin-right:0;margin-top:2.4375rem;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.21875rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;font-weight:600;text-rendering:optimizeLegibility;font-size:2rem;line-height:2.4375rem;border-bottom:1px solid hsla(0,0%,0%,0.07);}h2{margin-left:0;margin-right:0;margin-top:1.625rem;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.40625rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;font-weight:600;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:2.4375rem;border-bottom:1px solid hsla(0,0%,0%,0.07);}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;font-weight:600;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.625rem;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;font-weight:600;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.625rem;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;font-weight:600;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.625rem;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:hsla(0,0%,0%,0.53);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;font-weight:600;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.625rem;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}ul{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:0.85rem;line-height:1.42;background:hsla(0,0%,0%,0.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:0.8125rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:1rem;line-height:1.625rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}blockquote{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:calc(0.8125rem - 1px);padding-right:0;padding-top:0;margin-bottom:0.8125rem;border-left:4px solid hsla(0,0%,0%,0.13);color:hsla(0,0%,0%,0.53);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(0.8125rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}b{font-weight:600;}strong{font-weight:600;}dt{font-weight:600;}th{font-weight:600;}li{margin-bottom:calc(0.8125rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}li > ul{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(0.8125rem / 2);}code{font-size:0.85rem;line-height:1.625rem;}kbd{font-size:0.85rem;line-height:1.625rem;}samp{font-size:0.85rem;line-height:1.625rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:tnum;-moz-font-feature-settings:tnum;-ms-font-feature-settings:tnum;-webkit-font-feature-settings:tnum;padding-left:1.08333rem;padding-right:1.08333rem;padding-top:0.8125rem;padding-bottom:calc(0.8125rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}tt,code{background-color:hsla(0,0%,0%,0.04);border-radius:3px;font-family:Consolas,"Roboto Mono","Droid Sans Mono","Liberation Mono",Menlo,Courier,monospace;padding:0;padding-top:0.2em;padding-bottom:0.2em;}pre code{background:none;line-height:1.42;}code:before,code:after,tt:before,tt:after{letter-spacing:-0.2em;content:" ";}pre code:before,pre code:after,pre tt:before,pre tt:after{content:"";}h3,h4,h5,h6{margin-bottom:0.8125rem;margin-top:1.625rem;}ol,ul{margin-left:2.03125rem;}li>ol,li>ul{margin-left:2.03125rem;}a{color:#4078c0;text-decoration:none;}a:hover,a:active{text-decoration:underline;}</style><style>body{background:#f8fafc}.navbar{position:relative;z-index:20;margin-bottom:30px;border-bottom:1px solid #e5eff5;background:hsla(0,0%,100%,.97)}.navbar-flex{display:-ms-flexbox;display:flex;-ms-flex-direction:row;flex-direction:row}@media (max-width:400px){.navbar-flex{-ms-flex-direction:column;flex-direction:column}}.navbar-link{color:#738a94;padding:10px 12px;display:-ms-inline-flexbox;display:inline-flex}a,a.active{color:#ab5d5d}.grav{border-radius:50%;border:5px solid #fff}.big-link-con{display:-ms-flexbox;display:flex;-ms-flex-pack:center;justify-content:center}@media (max-width:500px){.big-link-con{-ms-flex-direction:column;flex-direction:column}}.emp{color:#ab5d5d}.primary{padding:10px;border-radius:6px;text-align:center;background-color:#ab5d5d;color:#fff;text-decoration:none;display:inline-block}.big-link,.primary{vertical-align:middle}.big-link{width:130px;height:110px;margin:8px;padding:15px;border-radius:6px;border:1px solid #738a94;display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;-ms-flex-pack:center;justify-content:center;background-color:transparent;color:#738a94}.big-link:hover{background-color:#ab5d5d;color:#fff;text-decoration:none;border-color:transparent}.blog-topics{margin-bottom:10px}.blog-topics a{margin-right:30px;color:#738a94}.blog-topics a.active{color:#ab5d5d}</style></head><body><div id="react-mount"><div data-reactroot="" data-reactid="1" data-react-checksum="-1489082294"><div data-reactid="2"><!-- react-empty: 3 --><div style="margin-bottom:1.625rem;" class="headroom-wrapper" data-reactid="4"><div style="position:relative;top:0;left:0;right:0;z-index:1;-webkit-transform:translateY(0);-ms-transform:translateY(0);transform:translateY(0);" class="headroom headroom--unfixed" data-reactid="5"><header class="navbar" data-reactid="6"><div style="max-width:750px;margin-left:auto;margin-right:auto;padding:0 1.21875rem;padding-top:0;" data-reactid="7"><div class="navbar-flex" data-reactid="8"><a style="margin-right:auto;" class="navbar-link" href="/" data-reactid="9">marcel.is</a><a class="navbar-link" href="/blog/" data-reactid="10">Blog</a><a class="navbar-link" href="/projects/" data-reactid="11">Tooling</a><a class="navbar-link" href="/hire/" data-reactid="12">Hire me 🚀</a></div><span style="display:block;clear:both;" data-reactid="13"> </span></div></header></div></div><div style="max-width:750px;margin-left:auto;margin-right:auto;padding:1.625rem 1.21875rem;padding-top:0;margin-bottom:3.25rem;" data-reactid="14"><div class="markdown" data-reactid="15"><!-- react-empty: 16 --><h1 data-reactid="17">How a newline can ruin your Hive</h1><span style="color:grey;" data-reactid="18">May 2015</span><div style="margin-top:2em;" data-reactid="19"><p>If you do not fully understand how Hive/Impala stores your data, it might cost you badly.</p>
<p>I’ve learnt the hard way.</p>
<h2>Symptom #1: Weird values in ingested Hive table</h2>
<p>You double-checked with <code>select distinct(gender) from customers</code> that the <code>gender</code> column in your source RDBMS really contains only values <code>male</code>, <code>female</code> and <code>NULL</code>. However, when you ingest the table into Hive (maybe with <a href="http://sqoop.apache.org/">Apache Sqoop</a> or <a href="https://github.com/datadudes/cornet">Cornet</a>) and run the check there,  you see that weird values have creeped in:</p>
<pre><code><span class="hljs-section">&gt; select distinct(gender) from customers;  // Run in Hive/Impala
+-----------------+</span>
<span class="hljs-section">| gender          |
+-----------------+</span>
| NULL            |
| CA 94304        |
| male            |
| Page Mill Road  |
<span class="hljs-section">| female          |
+-----------------+</span>
</code></pre>
<h2>Symptom #2: Inconsistent size of ingested Hive table</h2>
<p>You check with <code>select count(*) from customers</code> that the table in your RDBMS table has <code>156,010</code> rows.  You ingest the table into Hive and BAM! All of a sudden there are 14 more customers.</p>
<p>Maybe the business is doing great and you gained 14 customers before you started the ingestion? Wondering, you check the source table size again.</p>
<p>Still <code>156,010</code>.</p>
<h2>Symptom #3: Weird data when copied from another Hive table</h2>
<p>This one is by far the most strange one.</p>
<p>You already have the <code>customers</code> table ingested in Hive. Values in the <code>gender</code> column look fine. The table has correct size of <code>156,010</code>. All is fine.</p>
<p>You do some data cleaning with SQL and copy the result into a new table as follows:</p>
<pre><code><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customers_superclean
<span class="hljs-keyword">AS</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">name</span>, <span class="hljs-keyword">coalesce</span>(gender, <span class="hljs-string">'unknown'</span>) <span class="hljs-keyword">FROM</span> customers;
</code></pre>
<p>You check the size of the new table. BAM! 25 new customers in there. Impossible!</p>
<h2>No errors, no warnings</h2>
<p>Neither Hive, Impala nor Sqoop gave you any error or warning. You have no idea what’s going on. Somewhere at the back of your head, you start questioning the whole Hadoop infrastructure. You feel like the cool stuff you do all day with the data has been compromised.</p>
<h2>Cause: Hive delimiters present in the data</h2>
<p>All these problems can occur if the ingested data contains characters that Hive uses to delimit fields and rows. Typically, these are newlines. For instance, let’s assume that the <code>customers</code> table in the source RDBMS contains the following data (notice the newline in the first street name):</p>
<table>
<thead>
<tr>
<th>gender</th>
<th>street</th>
</tr>
</thead>
<tbody>
<tr>
<td>male</td>
<td>Page Mill Road<code>\n</code>CA 94304</td>
</tr>
<tr>
<td>female</td>
<td>Great America Parkway</td>
</tr>
</tbody>
</table>
<p>If one naively ingests this data into a Hive table using the default settings (a text file with rows delimited by <code>\01</code> and fields delimited by newlines), the data gets broken. Look at the corresponding delimited file in HDFS:</p>
<pre><code>male\<span class="hljs-number">01</span>Page Mill Road
CA <span class="hljs-number">94304</span>
female\<span class="hljs-number">01</span>Great America Parkway
</code></pre>
<p>When Hive/Impala reads from this file, it finds three customers instead of two. The additional customer is of gender <code>CA 94304</code> and has no street specified. On top of that, the street field of the first customer misses the postal code.</p>
<h2>Particularly interesting case: Copying binary data to text file</h2>
<p>Assume that the Hive table called <code>customers</code> uses Avro or Parquet for data storage and that the data contains newlines. Querying the <code>customers</code> table directly via Hive or Impala works as expected. However, let’s create a new table as follows:</p>
<pre><code><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customers_superclean
<span class="hljs-keyword">AS</span> <span class="hljs-keyword">SELECT</span> gender, street <span class="hljs-keyword">FROM</span> CUSTOMERS;
</code></pre>
<p>The problem with this command is that the new table is backed by a newline-delimited text file. An Avro/Parquet record which contains a newline will be split into two records in the new table. Symptom #3 is born.</p>
<h2>Solution 1: Use binary storage formats like Avro or Parquet</h2>
<p>If possible, use binary storage for your Hive tables, for instance <a href="https://avro.apache.org/">Apache Avro</a> or <a href="http://parquet.apache.org/">Apache Parquet</a>. Since these formats do not use dedicated characters to split a file into records and fields, Hive/Impala can read data with special characters properly.</p>
<p>Also, Avro and Parquet make it possible to safely copy records from one Hive table to another. For instance, checkout the following command which copies data to a Parquet table:</p>
<pre><code><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customers_superclean <span class="hljs-keyword">STORED</span> <span class="hljs-keyword">AS</span> parquet
<span class="hljs-keyword">AS</span> <span class="hljs-keyword">SELECT</span> gender, street <span class="hljs-keyword">FROM</span> customers;
</code></pre>
<p>The Parquet storage will ensure that even if  data in the <code>customers</code> table contains newlines or another delimiters, the data will be properly copied and interpreted in the new table.</p>
<h2>Solution 2: Ensure the delimited text file does not contain Hive delimiters</h2>
<p>When ingesting data into a delimited text file, you have to ensure that the file does not contain characters that Hive uses to split data into rows and fields. In general, there are two options to achieve this:</p>
<ul>
<li>Remove Hive delimiters from the data before ingestion. If you use Sqoop, there are handy parameters which can do that for you. Checkout the <a href="https://sqoop.apache.org/docs/1.4.5/SqoopUserGuide.html#_importing_data_into_hive">Sqoop docs</a> and look for <code>--hive-drop-import-delims</code> and  <code>--hive-delims-replacement</code> parameters.</li>
<li>Use custom Hive delimiters that are not present in the data. Unused <a href="http://en.wikipedia.org/wiki/ASCII#ASCII_control_characters">non-printable characters</a> are good candidates, for instance <code>\01</code> or <code>\02</code>. You can instruct Hive <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-RowFormat,StorageFormat,andSerDe">to use custom delimiters</a> as follows:</li>
</ul>
<pre><code><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> customers
<span class="hljs-keyword">ROW</span> <span class="hljs-keyword">FORMAT</span> <span class="hljs-keyword">DELIMITED</span>
  <span class="hljs-keyword">LINES</span> <span class="hljs-keyword">TERMINATED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'\002'</span>
  <span class="hljs-keyword">FIELDS</span> <span class="hljs-keyword">TERMINATED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'\001'</span>;
</code></pre>
<p>Happy ingesting!</p>
</div></div><span style="display:block;clear:both;" data-reactid="20"> </span></div></div></div></div><script src="/bundle.js?t=1487531204719"></script></body></html>