<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title data-react-helmet="true">marcel.is | How to ingest data from Azure DataMarket into Hadoop</title><meta data-react-helmet="true" name="description" content="Marcel Krcah blog"/><meta data-react-helmet="true" name="keywords" content="Big Data, Software Engineering, Marcel Krcah"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.625em -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;font-weight:normal;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}h1{margin-left:0;margin-right:0;margin-top:2.4375rem;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.21875rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;font-weight:600;text-rendering:optimizeLegibility;font-size:2rem;line-height:2.4375rem;border-bottom:1px solid hsla(0,0%,0%,0.07);}h2{margin-left:0;margin-right:0;margin-top:1.625rem;padding-bottom:calc(0.40625rem - 1px);padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.40625rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;font-weight:600;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:2.4375rem;border-bottom:1px solid hsla(0,0%,0%,0.07);}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;font-weight:600;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.625rem;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;font-weight:600;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.625rem;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;font-weight:600;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.625rem;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;color:hsla(0,0%,0%,0.53);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;font-weight:600;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.625rem;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}ul{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.625rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:0.85rem;line-height:1.42;background:hsla(0,0%,0%,0.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:0.8125rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;font-size:1rem;line-height:1.625rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}blockquote{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:calc(0.8125rem - 1px);padding-right:0;padding-top:0;margin-bottom:0.8125rem;border-left:4px solid hsla(0,0%,0%,0.13);color:hsla(0,0%,0%,0.53);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(0.8125rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:0.8125rem;}b{font-weight:600;}strong{font-weight:600;}dt{font-weight:600;}th{font-weight:600;}li{margin-bottom:calc(0.8125rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}li > ul{margin-left:1.625rem;margin-bottom:calc(0.8125rem / 2);margin-top:calc(0.8125rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(0.8125rem / 2);}code{font-size:0.85rem;line-height:1.625rem;}kbd{font-size:0.85rem;line-height:1.625rem;}samp{font-size:0.85rem;line-height:1.625rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:tnum;-moz-font-feature-settings:tnum;-ms-font-feature-settings:tnum;-webkit-font-feature-settings:tnum;padding-left:1.08333rem;padding-right:1.08333rem;padding-top:0.8125rem;padding-bottom:calc(0.8125rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}tt,code{background-color:hsla(0,0%,0%,0.04);border-radius:3px;font-family:Consolas,"Roboto Mono","Droid Sans Mono","Liberation Mono",Menlo,Courier,monospace;padding:0;padding-top:0.2em;padding-bottom:0.2em;}pre code{background:none;line-height:1.42;}code:before,code:after,tt:before,tt:after{letter-spacing:-0.2em;content:" ";}pre code:before,pre code:after,pre tt:before,pre tt:after{content:"";}h3,h4,h5,h6{margin-bottom:0.8125rem;margin-top:1.625rem;}ol,ul{margin-left:2.03125rem;}li>ol,li>ul{margin-left:2.03125rem;}a{color:#4078c0;text-decoration:none;}a:hover,a:active{text-decoration:underline;}</style><style>body{background:#f8fafc}.navbar{position:relative;z-index:20;margin-bottom:30px;border-bottom:1px solid #e5eff5;background:hsla(0,0%,100%,.97)}.navbar-flex{display:-ms-flexbox;display:flex;-ms-flex-direction:row;flex-direction:row}@media (max-width:400px){.navbar-flex{-ms-flex-direction:column;flex-direction:column}}.navbar-link{color:#738a94;padding:10px 12px;display:-ms-inline-flexbox;display:inline-flex}a,a.active{color:#ab5d5d}.grav{border-radius:50%;border:5px solid #fff}.big-link-con{display:-ms-flexbox;display:flex;-ms-flex-pack:center;justify-content:center}@media (max-width:500px){.big-link-con{-ms-flex-direction:column;flex-direction:column}}.emp{color:#ab5d5d}.primary{padding:10px;border-radius:6px;text-align:center;background-color:#ab5d5d;color:#fff;text-decoration:none;display:inline-block}.big-link,.primary{vertical-align:middle}.big-link{width:130px;height:110px;margin:8px;padding:15px;border-radius:6px;border:1px solid #738a94;display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;-ms-flex-pack:center;justify-content:center;background-color:transparent;color:#738a94}.big-link:hover{background-color:#ab5d5d;color:#fff;text-decoration:none;border-color:transparent}.blog-topics{margin-bottom:10px}.blog-topics a{margin-right:30px;color:#738a94}.blog-topics a.active{color:#ab5d5d}</style></head><body><div id="react-mount"><div data-reactroot="" data-reactid="1" data-react-checksum="-1961963830"><div data-reactid="2"><!-- react-empty: 3 --><div style="margin-bottom:1.625rem;" class="headroom-wrapper" data-reactid="4"><div style="position:relative;top:0;left:0;right:0;z-index:1;-webkit-transform:translateY(0);-ms-transform:translateY(0);transform:translateY(0);" class="headroom headroom--unfixed" data-reactid="5"><header class="navbar" data-reactid="6"><div style="max-width:750px;margin-left:auto;margin-right:auto;padding:0 1.21875rem;padding-top:0;" data-reactid="7"><div class="navbar-flex" data-reactid="8"><a style="margin-right:auto;" class="navbar-link" href="/" data-reactid="9">marcel.is</a><a class="navbar-link" href="/blog/" data-reactid="10">Blog</a><a class="navbar-link" href="/projects/" data-reactid="11">Tooling</a><a class="navbar-link" href="/hire/" data-reactid="12">Hire me 🚀</a></div><span style="display:block;clear:both;" data-reactid="13"> </span></div></header></div></div><div style="max-width:750px;margin-left:auto;margin-right:auto;padding:1.625rem 1.21875rem;padding-top:0;margin-bottom:3.25rem;" data-reactid="14"><div class="markdown" data-reactid="15"><!-- react-empty: 16 --><h1 data-reactid="17">How to ingest data from Azure DataMarket into Hadoop</h1><span style="color:grey;" data-reactid="18">April 2015</span><div style="margin-top:2em;" data-reactid="19"><p>For those of you who haven’t encountered it yet, <a href="https://datamarket.azure.com/browse/data">Azure DataMarket</a>
is quite an exciting platform by Microsoft which provides standardized access
to plenty of interesting datasets. As of now, there are over 200 datasets  from broad range of topics, including weather, demographics, automotive, agriculture,  real-estate, etc. There might be a golden nugget for your bussiness hidden in there, so I would definitely recommend to go and <a href="https://datamarket.azure.com/browse/data">check the platform out</a>.</p>
<p>Recently, we have discovered such a golden nugget ourselves: details about every car sold in Netherlands in the past 15 years. A pretty exciting dataset, considering that the company I work for operates in the Dutch market of electric vehicles. What is more, the data is <strong>free</strong>, <strong>updated daily</strong> and comes shipped with a <strong>REST API interface</strong>. What more can we wish for?</p>
<p>To maximally leverage potential of the dataset, we ingest it into Hive, which allows us to:</p>
<ul>
<li><strong>run fast ad-hoc exploratory SQL queries</strong> with <a href="http://impala.io/">Impala</a>,</li>
<li><strong>explore the dataset</strong> with BI tools,</li>
<li><strong>enrich the data model</strong> by combining car details with other data and</li>
<li><strong>expand our dashboards</strong> with insights about the car market.</li>
</ul>
<h2>Avro-backed external Hive tables FTW!</h2>
<p>Regarding the storage, we opted for an <a href="https://cwiki.apache.org/confluence/display/Hive/AvroSerDe">Avro-backed</a> <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-ExternalTables">external</a> Hive table. These types of tables rock, since:</p>
<ul>
<li><strong>Hive automatically infers table schema from the Avro schema</strong>. There is no need to explicitly enumerate columns with their types, which is very useful if you deal with tables of many columns.</li>
<li><strong>Changes in table schema are not an issue</strong>. You just recreate the table with the new Avro schema and the <a href="http://blog.cloudera.com/blog/2011/05/three-reasons-why-apache-avro-data-serialization-is-a-good-choice-for-openrtb/">Avro schema evolution</a> will automagically take care of properly reading the data stored with the old schema.</li>
<li><strong>Data is easily processed by other tools</strong> like Apache Spark or MapReduce. The data resides in a directory of your choice (rather than in a Hive directory) and the Avro format has first-class support in Hadoop tooling.</li>
<li><strong>New data is easily added to the table</strong>. Just add a new Avro file to the corresponding HDFS directory and Hive will automatically pick it up. With Impala, call <code>REFRESH &lt;table-name&gt;;</code> to notify Impala about arrival of new data.</li>
<li><strong><a href="http://blog.cloudera.com/blog/2014/08/improving-query-performance-using-partitioning-in-apache-hive/">Hive data partitioning</a> is well supported</strong> so you can optimize for query performance.</li>
<li><strong>Dropping external Hive table does not delete data from HDFS</strong>. Small thing, but very handy.</li>
</ul>
<h2>Ingestion: From OData XML to an Avro Hive table</h2>
<p>Here are detailed steps how we get that data from DataMarket into Hive.</p>
<h3>Step 1: Download the dataset as XML files, in a standardized OData format</h3>
<p>DataMarket publishes datasets as XML. Each XML follows the same <a href="http://www.odata.org/documentation/odata-version-2-0/atom-format">OData schema</a> (checkout the <a href="https://api.datamarket.azure.com/opendata.rdw/VRTG.Open.Data/v1/KENT_VRTG_O_DAT">example XML</a> with cars data). DataMarket provides this data via a REST interface, which supports various <a href="https://msdn.microsoft.com/en-us/library/gg312156.aspx">query parameters</a>. Using the parameters, you control the subset of data you want to download.</p>
<p>Since the car dataset that we are interested in is about 15 GiB large, filtering proved very useful for our purposes. With the <code>$filter</code>, <code>$top</code> and <code>$inlinecount</code> parameters and a bit of <code>curl</code> and Bash, it is straightforward to download the whole dataset into files <code>cars_2000.xml</code> till  <code>cars_2015.xml</code>, where the number indicates the year where a car was registered in Netherlands.</p>
<h3>Step 2: Convert the dataset into Avro, using <code>odata2avro</code> utility</h3>
<p>To convert an XML file in OData schema to Avro, we created a Python command-line tool called <a href="https://github.com/datadudes/odata2avro">odata2avro</a> which does all the heavy lifting for you.</p>
<p>Just install the tool with <code>pip install odata2avro</code> and use it as follows:</p>
<pre><code>$ odata2avro cars_2013<span class="hljs-selector-class">.xml</span> cars<span class="hljs-selector-class">.avsc</span> cars_2013<span class="hljs-selector-class">.avro</span>
</code></pre>
<p>This command reads an XML file <code>cars_2013.xml</code> and creates two files:</p>
<ul>
<li><code>cars.avsc</code> - an Avro schema, in json, describing the dataset,</li>
<li><code>cars_2013.avro</code> - a binary Avro file containing the dataset from the XML.</li>
</ul>
<h3>Step 3: Upload the Avro schema and Avro files to HDFS</h3>
<p>In this case, let’s create and upload the data to <code>/datamarket</code> HDFS directory:</p>
<pre><code>$ hdfs dfs -mkdir -<span class="hljs-selector-tag">p</span> /datamarket/cars
$ hdfs dfs -put cars_20*<span class="hljs-selector-class">.xml</span> /datamarket/cars
$ hdfs dfs -put cars<span class="hljs-selector-class">.avsc</span> /datamarket
</code></pre>
<h3>Step 4: Create an external Avro-backed Hive table</h3>
<p>To create an external Hive table with a schema according to  <code>/datamarket/cars.avsc</code> and the data located in <code>/datamarket/cars</code>, use the following Hive command with the <a href="https://cwiki.apache.org/confluence/display/Hive/AvroSerDe">AvroSerDe</a>:</p>
<pre><code><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">EXTERNAL</span> <span class="hljs-keyword">TABLE</span> cars
<span class="hljs-keyword">ROW</span> <span class="hljs-keyword">FORMAT</span> SERDE <span class="hljs-string">'org.apache.hadoop.hive.serde2.avro.AvroSerDe'</span>
<span class="hljs-keyword">STORED</span> <span class="hljs-keyword">AS</span> INPUTFORMAT <span class="hljs-string">'org.apache.hadoop.hive.ql.io.avro.AvroContainerInputFormat'</span>
OUTPUTFORMAT <span class="hljs-string">'org.apache.hadoop.hive.ql.io.avro.AvroContainerOutputFormat'</span>
LOCATION <span class="hljs-string">'/datamarket/cars'</span>
TBLPROPERTIES (<span class="hljs-string">'avro.schema.url'</span>=<span class="hljs-string">'hdfs:///datamarket/cars.avsc'</span>);
</code></pre>
<h3>Step 5: Query &amp; profit!</h3>
<p>Congrats! As of now, the data is accessible in both Hive and Impala:</p>
<pre><code>$ <span class="hljs-string">impala-shell </span><span class="hljs-built_in">--query</span> <span class="hljs-string">'select * from cars;'</span>
</code></pre>
<h2>Bonus step: Keeping data updated</h2>
<p>The <em>car</em> dataset is append-only, so for us it’s pretty straightforward to keep the data in Hive updated. We run a daily job which:</p>
<ul>
<li>downloads XML data from DataMarket for the current year 2015,</li>
<li>converts the XML data to an Avro file called <code>cars_2015.avro</code>,</li>
<li>uploads the Avro file to HDFS and replaces the file uploaded on the previous day and</li>
<li>calls <code>REFRESH cars;</code> so Impala registers the new data.</li>
</ul>
<p>That’s all!</p>
</div></div><br data-reactid="20"/><a href="http://eepurl.com/b_GvTD" data-reactid="21">Sign up for a newsletter</a><span style="display:block;clear:both;" data-reactid="22"> </span></div></div></div></div><script src="/bundle.js?t=1490782339964"></script></body></html>