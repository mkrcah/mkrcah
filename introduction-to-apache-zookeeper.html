<!DOCTYPE html>
<html lang="en">
<head>
        <title>marcel.is: Introduction to Apache Zookeeper, backbone of big-data systems</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="http://marcel.is/theme/css/main.css" type="text/css" />
        <link href="http://marcel.is/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="marcel.is ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://marcel.is/css/ie.css"/>
                <script src="http://marcel.is/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://marcel.is/css/ie6.css"/><![endif]-->

</head>

<body>
<h1>Introduction to Apache Zookeeper, backbone of big-data systems
</h1>
<p class="date">January 2015 </p>
<article>
    <p>Apache Kafka, Mesos, Hadoop/YARN, Neo4J, HBase, Solr. All of these services
(and <a href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/PoweredBy">many others</a>)
are built on top of Apache ZooKeeper. ZooKeeper is also a part of
all Hadoop distributions (e.g. <a href="http://www.cloudera.com/content/cloudera/en/products-and-services/cdh.html">Cloudera CDH</a>)
and is used in many companies, including LinkedIn, Twitter, Netflix or Yahoo.</p>
<p>So what is ZooKeeper all about and why is it that popular?</p>
<h2>In summary, ZooKeeper helps to build a distributed system</h2>
<p>Following the Unix philosophy of small yet powerful tools,
Zookeeper is a service that allows distributed processes to coordinate with each other.
Instead of developing such a coordination system from scratch, you can re-use ZooKeeper
and benefit from its best-practice proven implementation.</p>
<p>Distributed systems use ZooKeeper for service discovery, cluster monitoring,
configuration management, leader election or naming service. Also, ZooKeeper
provides foundation for building higher-level distributed functions like locks, barriers,
queues, two-phase commits, etc.</p>
<p>Or, as the Apache Zookeeper PMC <a href="https://www.hakkalabs.co/articles/apache-zookeeper-introduction/">puts it</a>:</p>
<blockquote>
<p>If you are doing distributed locking and you are not using ZooKeeper, you are crazy - Camille Fournier, Apache ZooKeeper PMC</p>
</blockquote>
<h2>ZooKeeper fundamentals: Z-nodes</h2>
<p>ZooKeeper itself is a distributed highly-available service that manages
a shared hierarchical name space of data registers, called <strong>z-nodes</strong>.</p>
<p><strong>Z-nodes</strong> very much resemble a filesystem. Each z-node has a path, e.g. <code>/services/product</code>, and data, given as <code>byte[]</code>. However, unlike directories in a filesystem, parent z-nodes can also carry data.</p>
<p>Here is an example of z-nodes hierarchy:
<img alt="Illustration of Zookeeper z-nodes" src="http://marcel.is/images/zookeeper-znodes.jpg" /></p>
<p>ZooKeeper provides a simple yet powerful <a href="https://zookeeper.apache.org/doc/r3.3.3/api/org/apache/zookeeper/ZooKeeper.html">API</a>
for z-node management. You can <em>create</em>, <em>get</em>, <em>update</em> and <em>delete</em> a z-node, ask if it <em>exists</em>
and <em>get children</em>.</p>
<p>The interesting part, however, lies in the <strong>consistency guarantees</strong> that ZooKeeper provides:</p>
<ul>
<li><strong>Sequential consistency</strong> -  Updates are applied in order they are received by ZooKeeper</li>
<li><strong>Update atomicity</strong> - Updates are either successful or failed. No partial results</li>
<li><strong>Single system image</strong> - A client sees the same view of the service regardless of the ZooKeeper server it connects to</li>
<li><strong>Reliability</strong> - Once an update has been applied, it will persist from that time forward until a client overwrites the update</li>
<li><strong>Timeliness</strong> - The clients view of the system is guaranteed to be up-to-date within a certain time bound</li>
</ul>
<p>I hope that by now you start to feel the power of ZooKeeper. However, this is not all.</p>
<h2>Persistent, ephemeral and sequential z-nodes</h2>
<p>Regarding persistence, ZooKeeper offers two types of z-nodes: <strong>persistent</strong> and <strong>ephemeral</strong>.</p>
<p><strong>Persistent z-nodes</strong> are the default z-nodes, they exist until they are explicitly deleted.</p>
<p><strong>Ephemeral z-nodes</strong>, on the other hand, are attached to a client session. If a
client dies, the session is terminated and the ephemeral z-done is deleted. How great is that!
You can very easily monitor clieant failures: If a client responsible for
performing an exclusive operation fails, the corresponding ephemeral z-node is deleted and other clients
are notified to take over the operation.</p>
<p>Both persistent and ephemeral z-nodes can be also marked as <strong>sequential</strong>.</p>
<p>For <strong>sequential z-nodes</strong>, ZooKeeper automatically appends a monotically increasing counter to the end of a path.
This is greatly helpful for synchronization: if more clients want to get a lock on a resource <code>A</code>,
they can each create a sequential z-node on path <code>resource/A</code>. The client getting the lowest number is entitled to the lock.</p>
<h2>Watches</h2>
<p>ZooKeeper also offers a mechanism called <strong>watches</strong>.
A watch is just a one-time callback, which is triggered every time
a z-node changes. Watches are one-shot - if you need to continually monitor a z-node,
you need to reset the watch after each event.</p>
<p>Watches are very useful to if you don't want to periodically poll your z-nodes.</p>
<h2>Fault-tolerant, highly-available, read-performant</h2>
<p>Zookeeper can run in both stand-alone and distributed fault-tolerant mode.
When running in a cluster, a group of ZooKeeper servers is called an <strong>ensemble</strong>.</p>
<p>Regarding node failures, ZooKeeper <strong>tolerates loss of ensemble minority</strong>
(there is <a href="http://en.wikipedia.org/wiki/Paxos_%28computer_science%29">Paxos</a> under the hood).
So if the ensemble consists of three or four machines, ZooKeeper will tolerate failure
of only one machine in both of these cases. This is why it is recommended
to run the ZooKeeper ensemble on <strong>an odd number of hosts</strong>, since even number
of machines doesn't bring any benefit with respect to node failures.</p>
<p>ZooKeeper data is kept in memory and is backed up to a log for reliability.
It is optimized for read dominant workloads, handling up to 50k operations per second.</p>
<h2>Clients</h2>
<p>ZooKeeper clients can connect to any of the ensemble members and maintain a connection.</p>
<p>ZooKeeper is build on Java, but there is a pretty <a href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/ZKClientBindings">solid list</a> of client bindings,
including Java, Scala, Node.js, Erlang, Haskell, Python, C#, Go and Ruby.</p>
<p>The most popular client is <a href="http://curator.apache.org/">Apache Curator</a> (former LinkedIn project).
Definitely checkout the <a href="http://curator.apache.org/curator-recipes/index.html">Curator support for high-level recipes</a>,
it's a very interesting read.</p>
<h2>Use-cases</h2>
<p>Here is a couple of examples how ZooKeeper is used in practice:</p>
<p>Twitter uses ZooKeeper for <strong>service discovery</strong>. Each application instance
registers itself to ZooKeeper using an ephemeral z-node. In this way,
ZooKeeper can maintain an up-to-date list of running instances for each type of service.
Clients then query ZooKeeper to locate application instances.
In general, ZooKeeper might help you to build a
<strong>micro-service infrastructure</strong> or manage a network of <strong>replicated
(REST) services</strong>.</p>
<p><a href="http://lucene.apache.org/solr/">Apache Solr</a> uses ZooKeeper for <strong>leader election, centralized configuration</strong> and <strong>cluster management</strong>. ZooKeeper enables application servers to <strong>bootstrap configuration</strong>
from ZooKeeper as soon as they join the system and to keep the configuration up-to-date.</p>
<p>Cluster monitoring can be implemented as members registering to <code>/members/host-{i}</code> and
periodically updating the z-node with their status (load, memory, CPU etc). Each z-node update
then triggers an alert to z-node listeners using watches.</p>
<p><a href="https://www.google.cz/search?q=apache+kafka&amp;rlz=1C5CHFA_enCZ546CZ546&amp;oq=apache+kafka&amp;aqs=chrome..69i57j69i59l2j0l3.1551j0j9&amp;sourceid=chrome&amp;es_sm=91&amp;ie=UTF-8">Apache Kafka</a>, a popular publish/subscribe system with persistent queues,
uses ZooKeeper to store client's last consumed
offset, to register Kafka brokers and to help load balance requests among live brokers.</p>
<p><a href="http://hadoop.apache.org/">Apache Hadoop</a> uses ZooKeeper for automatic failover of Hadoop HDFS Namenode and for high-availability of YARN resources.</p>
<p>Pretty amazing!</p>
<h2>Where to go from here</h2>
<p>I was quite eager to experiment with the ensemble, so I made
this <a href="https://github.com/mkrcah/virtual-zookeeper-cluster">automated script</a> which creates and provision a virtual 3-node ensemble on your local machine with one command using Vagrant and Ansible. <a href="https://github.com/mkrcah/virtual-zookeeper-cluster">Check it out</a>.</p>
<p>Also, if you want to dive deeper, I'd recommend to:</p>
<ul>
<li>Read the <a href="http://zookeeper.apache.org/doc/trunk/zookeeperStarted.html">Getting started guide </a> on the official ZooKeeper website</li>
<li>Checkout the <a href="http://zookeeper.apache.org/doc/trunk/recipes.html">Zookeeper recipies</a></li>
<li>Bookmark the <a href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/ZooKeeperPresentations">curated list of Zookeeper presentations</a></li>
<li>Read a use-case of <a href="http://blog.cloudera.com/blog/2009/05/building-a-distributed-concurrent-queue-with-apache-zookeeper/">building a distributed concurrent queue in Zookeeper</a></li>
<li>Checkout <a href="http://www.ebaytechblog.com/2012/09/13/grid-computing-with-fault-tolerant-actors-and-zookeeper/#.VKLmpsAAE">Grid Computing with Fault-Tolerant Actors and ZooKeeper</a> - eBay tech blog</li>
</ul>
<p><strong>Happy ZooKeeping!</strong></p>
</article>
<p class="footer">
  <a href="/connect">subscribe</a>&nbsp;&nbsp;
  <a href="/home">home</a></p>

    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-53104817-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>
</body>

</html>